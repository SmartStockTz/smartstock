"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Client = void 0;

var _logger = _interopRequireDefault(require("../logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const dafaultFields = ['className', 'objectId', 'updatedAt', 'createdAt', 'ACL'];

class Client {
  constructor(id, parseWebSocket, hasMasterKey) {
    this.id = id;
    this.parseWebSocket = parseWebSocket;
    this.hasMasterKey = hasMasterKey;
    this.roles = [];
    this.subscriptionInfos = new Map();
    this.pushConnect = this._pushEvent('connected');
    this.pushSubscribe = this._pushEvent('subscribed');
    this.pushUnsubscribe = this._pushEvent('unsubscribed');
    this.pushCreate = this._pushEvent('create');
    this.pushEnter = this._pushEvent('enter');
    this.pushUpdate = this._pushEvent('update');
    this.pushDelete = this._pushEvent('delete');
    this.pushLeave = this._pushEvent('leave');
  }

  static pushResponse(parseWebSocket, message) {
    _logger.default.verbose('Push Response : %j', message);

    parseWebSocket.send(message);
  }

  static pushError(parseWebSocket, code, error, reconnect = true) {
    Client.pushResponse(parseWebSocket, JSON.stringify({
      op: 'error',
      error: error,
      code: code,
      reconnect: reconnect
    }));
  }

  addSubscriptionInfo(requestId, subscriptionInfo) {
    this.subscriptionInfos.set(requestId, subscriptionInfo);
  }

  getSubscriptionInfo(requestId) {
    return this.subscriptionInfos.get(requestId);
  }

  deleteSubscriptionInfo(requestId) {
    return this.subscriptionInfos.delete(requestId);
  }

  _pushEvent(type) {
    return function (subscriptionId, parseObjectJSON, parseOriginalObjectJSON) {
      const response = {
        op: type,
        clientId: this.id
      };

      if (typeof subscriptionId !== 'undefined') {
        response['requestId'] = subscriptionId;
      }

      if (typeof parseObjectJSON !== 'undefined') {
        let fields;

        if (this.subscriptionInfos.has(subscriptionId)) {
          fields = this.subscriptionInfos.get(subscriptionId).fields;
        }

        response['object'] = this._toJSONWithFields(parseObjectJSON, fields);

        if (typeof parseOriginalObjectJSON !== 'undefined') {
          response['original'] = this._toJSONWithFields(parseOriginalObjectJSON, fields);
        }
      }

      Client.pushResponse(this.parseWebSocket, JSON.stringify(response));
    };
  }

  _toJSONWithFields(parseObjectJSON, fields) {
    if (!fields) {
      return parseObjectJSON;
    }

    const limitedParseObject = {};

    for (const field of dafaultFields) {
      limitedParseObject[field] = parseObjectJSON[field];
    }

    for (const field of fields) {
      if (field in parseObjectJSON) {
        limitedParseObject[field] = parseObjectJSON[field];
      }
    }

    return limitedParseObject;
  }

}

exports.Client = Client;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9MaXZlUXVlcnkvQ2xpZW50LmpzIl0sIm5hbWVzIjpbImRhZmF1bHRGaWVsZHMiLCJDbGllbnQiLCJjb25zdHJ1Y3RvciIsImlkIiwicGFyc2VXZWJTb2NrZXQiLCJoYXNNYXN0ZXJLZXkiLCJyb2xlcyIsInN1YnNjcmlwdGlvbkluZm9zIiwiTWFwIiwicHVzaENvbm5lY3QiLCJfcHVzaEV2ZW50IiwicHVzaFN1YnNjcmliZSIsInB1c2hVbnN1YnNjcmliZSIsInB1c2hDcmVhdGUiLCJwdXNoRW50ZXIiLCJwdXNoVXBkYXRlIiwicHVzaERlbGV0ZSIsInB1c2hMZWF2ZSIsInB1c2hSZXNwb25zZSIsIm1lc3NhZ2UiLCJsb2dnZXIiLCJ2ZXJib3NlIiwic2VuZCIsInB1c2hFcnJvciIsImNvZGUiLCJlcnJvciIsInJlY29ubmVjdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJvcCIsImFkZFN1YnNjcmlwdGlvbkluZm8iLCJyZXF1ZXN0SWQiLCJzdWJzY3JpcHRpb25JbmZvIiwic2V0IiwiZ2V0U3Vic2NyaXB0aW9uSW5mbyIsImdldCIsImRlbGV0ZVN1YnNjcmlwdGlvbkluZm8iLCJkZWxldGUiLCJ0eXBlIiwic3Vic2NyaXB0aW9uSWQiLCJwYXJzZU9iamVjdEpTT04iLCJwYXJzZU9yaWdpbmFsT2JqZWN0SlNPTiIsInJlc3BvbnNlIiwiY2xpZW50SWQiLCJmaWVsZHMiLCJoYXMiLCJfdG9KU09OV2l0aEZpZWxkcyIsImxpbWl0ZWRQYXJzZU9iamVjdCIsImZpZWxkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7QUFLQSxNQUFNQSxhQUFhLEdBQUcsQ0FDcEIsV0FEb0IsRUFFcEIsVUFGb0IsRUFHcEIsV0FIb0IsRUFJcEIsV0FKb0IsRUFLcEIsS0FMb0IsQ0FBdEI7O0FBUUEsTUFBTUMsTUFBTixDQUFhO0FBZ0JYQyxFQUFBQSxXQUFXLENBQUNDLEVBQUQsRUFBYUMsY0FBYixFQUFrQ0MsWUFBbEMsRUFBeUQ7QUFDbEUsU0FBS0YsRUFB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Q0FBdUJOLGVBQXZCLEVBQXdDSSxNQUF4QyxDQUFyQjs7QUFDQSxZQUFJLE9BQU9ILHVCQUFQLEtBQW1DLFdBQXZDLEVBQW9EO0FBQ2xEQyxVQUFBQSxRQUFRLENBQUMsVUFBRCxDQUFSLEdBQXVCLEtBQUtJLGlCQUFMLENBQ3JCTCx1QkFEcUIsRUFFckJHLE1BRnFCLENBQXZCO0FBSUQ7QUFDRjs7QUFDRDNDLE1BQUFBLE1BQU0sQ0FBQ2lCLFlBQVAsQ0FBb0IsS0FBS2QsY0FBekIsRUFBeUN1QixJQUFJLENBQUNDLFNBQUwsQ0FBZWMsUUFBZixDQUF6QztBQUNELEtBMUJEO0FBMkJEOztBQUVESSxFQUFBQSxpQkFBaUIsQ0FBQ04sZUFBRCxFQUF1QkksTUFBdkIsRUFBeUQ7QUFDeEUsUUFBSSxDQUFDQSxNQUFMLEVBQWE7QUFDWCxhQUFPSixlQUFQO0FBQ0Q7O0FBQ0QsVUFBTU8sa0JBQWtCLEdBQUcsRUFBM0I7O0FBQ0EsU0FBSyxNQUFNQyxLQUFYLElBQW9CaEQsYUFBcEIsRUFBbUM7QUFDakMrQyxNQUFBQSxrQkFBa0IsQ0FBQ0MsS0FBRCxDQUFsQixHQUE0QlIsZUFBZSxDQUFDUSxLQUFELENBQTNDO0FBQ0Q7O0FBQ0QsU0FBSyxNQUFNQSxLQUFYLElBQW9CSixNQUFwQixFQUE0QjtBQUMxQixVQUFJSSxLQUFLLElBQUlSLGVBQWIsRUFBOEI7QUFDNUJPLFFBQUFBLGtCQUFrQixDQUFDQyxLQUFELENBQWxCLEdBQTRCUixlQUFlLENBQUNRLEtBQUQsQ0FBM0M7QUFDRDtBQUNGOztBQUNELFdBQU9ELGtCQUFQO0FBQ0Q7O0FBOUdVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuXG5pbXBvcnQgdHlwZSB7IEZsYXR0ZW5lZE9iamVjdERhdGEgfSBmcm9tICcuL1N1YnNjcmlwdGlvbic7XG5leHBvcnQgdHlwZSBNZXNzYWdlID0geyBbYXR0cjogc3RyaW5nXTogYW55IH07XG5cbmNvbnN0IGRhZmF1bHRGaWVsZHMgPSBbXG4gICdjbGFzc05hbWUnLFxuICAnb2JqZWN0SWQnLFxuICAndXBkYXRlZEF0JyxcbiAgJ2NyZWF0ZWRBdCcsXG4gICdBQ0wnLFxuXTtcblxuY2xhc3MgQ2xpZW50IHtcbiAgaWQ6IG51bWJlcjtcbiAgcGFyc2VXZWJTb2NrZXQ6IGFueTtcbiAgaGFzTWFzdGVyS2V5OiBib29sZWFuO1xuICB1c2VySWQ6IHN0cmluZztcbiAgcm9sZXM6IEFycmF5PHN0cmluZz47XG4gIHN1YnNjcmlwdGlvbkluZm9zOiBPYmplY3Q7XG4gIHB1c2hDb25uZWN0OiBGdW5jdGlvbjtcbiAgcHVzaFN1YnNjcmliZTogRnVuY3Rpb247XG4gIHB1c2hVbnN1YnNjcmliZTogRnVuY3Rpb247XG4gIHB1c2hDcmVhdGU6IEZ1bmN0aW9uO1xuICBwdXNoRW50ZXI6IEZ1bmN0aW9uO1xuICBwdXNoVXBkYXRlOiBGdW5jdGlvbjtcbiAgcHVzaERlbGV0ZTogRnVuY3Rpb247XG4gIHB1c2hMZWF2ZTogRnVuY3Rpb247XG5cbiAgY29uc3RydWN0b3IoaWQ6IG51bWJlciwgcGFyc2VXZWJTb2NrZXQ6IGFueSwgaGFzTWFzdGVyS2V5OiBib29sZWFuKSB7XG4gICAgdGhpcy5pZCA9IGlkO1xuICAgIHRoaXMucGFyc2VXZWJTb2NrZXQgPSBwYXJzZVdlYlNvY2tldDtcbiAgICB0aGlzLmhhc01hc3RlcktleSA9IGhhc01hc3RlcktleTtcbiAgICB0aGlzLnJvbGVzID0gW107XG4gICAgdGhpcy5zdWJzY3JpcHRpb25JbmZvcyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLnB1c2hDb25uZWN0ID0gdGhpcy5fcHVzaEV2ZW50KCdjb25uZWN0ZWQnKTtcbiAgICB0aGlzLnB1c2hTdWJzY3JpYmUgPSB0aGlzLl9wdXNoRXZlbnQoJ3N1YnNjcmliZWQnKTtcbiAgICB0aGlzLnB1c2hVbnN1YnNjcmliZSA9IHRoaXMuX3B1c2hFdmVudCgndW5zdWJzY3JpYmVkJyk7XG4gICAgdGhpcy5wdXNoQ3JlYXRlID0gdGhpcy5fcHVzaEV2ZW50KCdjcmVhdGUnKTtcbiAgICB0aGlzLnB1c2hFbnRlciA9IHRoaXMuX3B1c2hFdmVudCgnZW50ZXInKTtcbiAgICB0aGlzLnB1c2hVcGRhdGUgPSB0aGlzLl9wdXNoRXZlbnQoJ3VwZGF0ZScpO1xuICAgIHRoaXMucHVzaERlbGV0ZSA9IHRoaXMuX3B1c2hFdmVudCgnZGVsZXRlJyk7XG4gICAgdGhpcy5wdXNoTGVhdmUgPSB0aGlzLl9wdXNoRXZlbnQoJ2xlYXZlJyk7XG4gIH1cblxuICBzdGF0aWMgcHVzaFJlc3BvbnNlKHBhcnNlV2ViU29ja2V0OiBhbnksIG1lc3NhZ2U6IE1lc3NhZ2UpOiB2b2lkIHtcbiAgICBsb2dnZXIudmVyYm9zZSgnUHVzaCBSZXNwb25zZSA6ICVqJywgbWVzc2FnZSk7XG4gICAgcGFyc2VXZWJTb2NrZXQuc2VuZChtZXNzYWdlKTtcbiAgfVxuXG4gIHN0YXRpYyBwdXNoRXJyb3IoXG4gICAgcGFyc2VXZWJTb2NrZXQ6IGFueSxcbiAgICBjb2RlOiBudW1iZXIsXG4gICAgZXJyb3I6IHN0cmluZyxcbiAgICByZWNvbm5lY3Q6IGJvb2xlYW4gPSB0cnVlXG4gICk6IHZvaWQge1xuICAgIENsaWVudC5wdXNoUmVzcG9uc2UoXG4gICAgICBwYXJzZVdlYlNvY2tldCxcbiAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgb3A6ICdlcnJvcicsXG4gICAgICAgIGVycm9yOiBlcnJvcixcbiAgICAgICAgY29kZTogY29kZSxcbiAgICAgICAgcmVjb25uZWN0OiByZWNvbm5lY3QsXG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBhZGRTdWJzY3JpcHRpb25JbmZvKHJlcXVlc3RJZDogbnVtYmVyLCBzdWJzY3JpcHRpb25JbmZvOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLnNldChyZXF1ZXN0SWQsIHN1YnNjcmlwdGlvbkluZm8pO1xuICB9XG5cbiAgZ2V0U3Vic2NyaXB0aW9uSW5mbyhyZXF1ZXN0SWQ6IG51bWJlcik6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuc3Vic2NyaXB0aW9uSW5mb3MuZ2V0KHJlcXVlc3RJZCk7XG4gIH1cblxuICBkZWxldGVTdWJzY3JpcHRpb25JbmZvKHJlcXVlc3RJZDogbnVtYmVyKTogdm9pZCB7XG4gICAgcmV0dXJuIHRoaXMuc3Vic2NyaXB0aW9uSW5mb3MuZGVsZXRlKHJlcXVlc3RJZCk7XG4gIH1cblxuICBfcHVzaEV2ZW50KHR5cGU6IHN0cmluZyk6IEZ1bmN0aW9uIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oXG4gICAgICBzdWJzY3JpcHRpb25JZDogbnVtYmVyLFxuICAgICAgcGFyc2VPYmplY3RKU09OOiBhbnksXG4gICAgICBwYXJzZU9yaWdpbmFsT2JqZWN0SlNPTjogYW55XG4gICAgKTogdm9pZCB7XG4gICAgICBjb25zdCByZXNwb25zZTogTWVzc2FnZSA9IHtcbiAgICAgICAgb3A6IHR5cGUsXG4gICAgICAgIGNsaWVudElkOiB0aGlzLmlkLFxuICAgICAgfTtcbiAgICAgIGlmICh0eXBlb2Ygc3Vic2NyaXB0aW9uSWQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHJlc3BvbnNlWydyZXF1ZXN0SWQnXSA9IHN1YnNjcmlwdGlvbklkO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBwYXJzZU9iamVjdEpTT04gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGxldCBmaWVsZHM7XG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmhhcyhzdWJzY3JpcHRpb25JZCkpIHtcbiAgICAgICAgICBmaWVsZHMgPSB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmdldChzdWJzY3JpcHRpb25JZCkuZmllbGRzO1xuICAgICAgICB9XG4gICAgICAgIHJlc3BvbnNlWydvYmplY3QnXSA9IHRoaXMuX3RvSlNPTldpdGhGaWVsZHMocGFyc2VPYmplY3RKU09OLCBmaWVsZHMpO1xuICAgICAgICBpZiAodHlwZW9mIHBhcnNlT3JpZ2luYWxPYmplY3RKU09OICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIHJlc3BvbnNlWydvcmlnaW5hbCddID0gdGhpcy5fdG9KU09OV2l0aEZpZWxkcyhcbiAgICAgICAgICAgIHBhcnNlT3JpZ2luYWxPYmplY3RKU09OLFxuICAgICAgICAgICAgZmllbGRzXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgQ2xpZW50LnB1c2hSZXNwb25zZSh0aGlzLnBhcnNlV2ViU29ja2V0LCBKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuICAgIH07XG4gIH1cblxuICBfdG9KU09OV2l0aEZpZWxkcyhwYXJzZU9iamVjdEpTT046IGFueSwgZmllbGRzOiBhbnkpOiBGbGF0dGVuZWRPYmplY3REYXRhIHtcbiAgICBpZiAoIWZpZWxkcykge1xuICAgICAgcmV0dXJuIHBhcnNlT2JqZWN0SlNPTjtcbiAgICB9XG4gICAgY29uc3QgbGltaXRlZFBhcnNlT2JqZWN0ID0ge307XG4gICAgZm9yIChjb25zdCBmaWVsZCBvZiBkYWZhdWx0RmllbGRzKSB7XG4gICAgICBsaW1pdGVkUGFyc2VPYmplY3RbZmllbGRdID0gcGFyc2VPYmplY3RKU09OW2ZpZWxkXTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBmaWVsZCBvZiBmaWVsZHMpIHtcbiAgICAgIGlmIChmaWVsZCBpbiBwYXJzZU9iamVjdEpTT04pIHtcbiAgICAgICAgbGltaXRlZFBhcnNlT2JqZWN0W2ZpZWxkXSA9IHBhcnNlT2JqZWN0SlNPTltmaWVsZF07XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBsaW1pdGVkUGFyc2VPYmplY3Q7XG4gIH1cbn1cblxuZXhwb3J0IHsgQ2xpZW50IH07XG4iXX0=