"use strict";

const Parse = require('parse/node').Parse;

const url = require('url');

const path = require('path'); // These methods handle batch requests.


const batchPath = '/batch'; // Mounts a batch-handler onto a PromiseRouter.

function mountOnto(router) {
  router.route('POST', batchPath, req => {
    return handleBatch(router, req);
  });
}

function parseURL(URL) {
  if (typeof URL === 'string') {
    return url.parse(URL);
  }

  return undefined;
}

function makeBatchRoutingPathFunction(originalUrl, serverURL, publicServerURL) {
  serverURL = serverURL ? parseURL(serverURL) : undefined;
  publicServerURL = publicServerURL ? parseURL(publicServerURL) : undefined;
  const apiPrefixLength = originalUrl.length - batchPath.length;
  let apiPrefix = originalUrl.slice(0, apiPrefixLength);

  const makeRoutablePath = function (requestPath) {
    // The routablePath is the path minus the api prefix
    if (requestPath.slice(0, apiPrefix.length) != apiPrefix) {
      throw new Parse.Error(Parse.Error.INVALID_JSON, 'cannot route batch path ' + requestPath);
    }

    return path.posix.join('/', requestPath.slice(apiPrefix.length));
  };

  if (serverURL && publicServerURL && serverURL.path != publicServerURL.path) {
    const localPath = serverURL.path;
    const publicPath = publicServerURL.path; // Override the api prefix

    apiPrefix = localPath;
    return function (requestPath) {
      // Build the new path by removing the public path
      // and joining with the local path
      const newPath = path.posix.join('/', localPath, '/', requestPath.slice(publicPath.length)); // Use the method for local routing

      return makeRoutablePath(newPath);
    };
  }

  return makeRoutablePath;
} // Returns a promise for a {response} object.
// TODO: pass along auth correctly


function handleBatch(router, req) {
  if (!Array.isArray(req.body.requests)) {
    throw new Parse.Error(Parse.Error.INVALID_JSON, 'requests must be an array');
  } // The batch paths are all from the root of our domain.
  // That means they include the API prefix, that the API is mounted
  // to. However, our promise router does not route the api prefix. So
  // we need to figure out the API prefix, so that we can strip it
  // from all the subrequests.


  if (!req.originalUrl.endsWith(batchPath)) {
    throw 'internal routing problem - expected url to end with batch';
  }

  const makeRoutablePath = makeBatchRoutingPathFunction(req.originalUrl, req.config.serverURL, req.config.publicServerURL);
  const promises = req.body.requests.map(restRequest => {
    const routablePath = makeRoutablePath(restRequest.path); // Construct a request that we can send to a handler

    const request = {
      body: restRequest.body,
      config: req.config,
      auth: req.auth,
      info: req.info
    };
    return router.tryRouteRequest(restRequest.method, routablePath, request).then(response => {
      return {
        success: response.response
      };
    }, error => {
      return {
        error: {
          code: error.code,
          error: error.message
        }
      };
    });
  });
  return Promise.all(promises).then(results => {
    return {
      response: results
    };
  });
}

module.exports = {
  mountOnto,
  makeBatchRoutingPathFunction
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9iYXRjaC5qcyJdLCJuYW1lcyI6WyJQYXJzZSIsInJlcXVpcmUiLCJ1cmwiLCJwYXRoIiwiYmF0Y2hQYXRoIiwibW91bnRPbnRvIiwicm91dGVyIiwicm91dGUiLCJyZXEiLCJoYW5kbGVCYXRjaCIsInBhcnNlVVJMIiwiVVJMIiwicGFyc2UiLCJ1bmRlZmluZWQiLCJtYWtlQmF0Y2hSb3V0aW5nUGF0aEZ1bmN0aW9uIiwib3JpZ2luYWxVcmwiLCJzZXJ2ZXJVUkwiLCJwdWJsaWNTZXJ2ZXJVUkwiLCJhcGlQcmVmaXhMZW5ndGgiLCJsZW5ndGgiLCJhcGlQcmVmaXgiLCJzbGljZSIsIm1ha2VSb3V0YWJsZVBhdGgiLCJyZXF1ZXN0UGF0aCIsIkVycm9yIiwiSU5WQUxJRF9KU09OIiwicG9zaXgiLCJqb2luIiwibG9jYWxQYXRoIiwicHVibGljUGF0aCIsIm5ld1BhdGgiLCJBcnJheSIsImlzQXJyYXkiLCJib2R5IiwicmVxdWVzdHMiLCJlbmRzV2l0aCIsImNvbmZpZyIsInByb21pc2VzIiwibWFwIiwicmVzdFJlcXVlc3QiLCJyb3V0YWJsZVBhdGgiLCJyZXF1ZXN0IiwiYXV0aCIsImluZm8iLCJ0cnlSb3V0ZVJlcXVlc3QiLCJtZXRob2QiLCJ0aGVuIiwicmVzcG9uc2UiLCJzdWNjZXNzIiwiZXJyb3IiLCJjb2RlIiwibWVzc2FnZSIsIlByb21pc2UiLCJhbGwiLCJyZXN1bHRzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxZQUFELENBQVAsQ0FBc0JELEtBQXBDOztBQUNBLE1BQU1FLEdBQUcsR0FBR0QsT0FBTyxDQUFDLEtBQUQsQ0FBbkI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBRCxDQUFwQixDLENBQ0E7OztBQUNBLE1BQU1HLFNBQVMsR0FBRyxRQUFsQixDLENBRUE7O0FBQ0EsU0FBU0MsU0FBVCxDQUFtQkMsTUFBbkIsRUFBMkI7QUFD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QVEsRUFBRU87QUFBWixLQUFQO0FBQ0QsR0FGTSxDQUFQO0FBR0Q7O0FBRURDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUNmbkQsRUFBQUEsU0FEZTtBQUVmUyxFQUFBQTtBQUZlLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgUGFyc2UgPSByZXF1aXJlKCdwYXJzZS9ub2RlJykuUGFyc2U7XG5jb25zdCB1cmwgPSByZXF1aXJlKCd1cmwnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG4vLyBUaGVzZSBtZXRob2RzIGhhbmRsZSBiYXRjaCByZXF1ZXN0cy5cbmNvbnN0IGJhdGNoUGF0aCA9ICcvYmF0Y2gnO1xuXG4vLyBNb3VudHMgYSBiYXRjaC1oYW5kbGVyIG9udG8gYSBQcm9taXNlUm91dGVyLlxuZnVuY3Rpb24gbW91bnRPbnRvKHJvdXRlcikge1xuICByb3V0ZXIucm91dGUoJ1BPU1QnLCBiYXRjaFBhdGgsIHJlcSA9PiB7XG4gICAgcmV0dXJuIGhhbmRsZUJhdGNoKHJvdXRlciwgcmVxKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlVVJMKFVSTCkge1xuICBpZiAodHlwZW9mIFVSTCA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gdXJsLnBhcnNlKFVSTCk7XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gbWFrZUJhdGNoUm91dGluZ1BhdGhGdW5jdGlvbihvcmlnaW5hbFVybCwgc2VydmVyVVJMLCBwdWJsaWNTZXJ2ZXJVUkwpIHtcbiAgc2VydmVyVVJMID0gc2VydmVyVVJMID8gcGFyc2VVUkwoc2VydmVyVVJMKSA6IHVuZGVmaW5lZDtcbiAgcHVibGljU2VydmVyVVJMID0gcHVibGljU2VydmVyVVJMID8gcGFyc2VVUkwocHVibGljU2VydmVyVVJMKSA6IHVuZGVmaW5lZDtcblxuICBjb25zdCBhcGlQcmVmaXhMZW5ndGggPSBvcmlnaW5hbFVybC5sZW5ndGggLSBiYXRjaFBhdGgubGVuZ3RoO1xuICBsZXQgYXBpUHJlZml4ID0gb3JpZ2luYWxVcmwuc2xpY2UoMCwgYXBpUHJlZml4TGVuZ3RoKTtcblxuICBjb25zdCBtYWtlUm91dGFibGVQYXRoID0gZnVuY3Rpb24ocmVxdWVzdFBhdGgpIHtcbiAgICAvLyBUaGUgcm91dGFibGVQYXRoIGlzIHRoZSBwYXRoIG1pbnVzIHRoZSBhcGkgcHJlZml4XG4gICAgaWYgKHJlcXVlc3RQYXRoLnNsaWNlKDAsIGFwaVByZWZpeC5sZW5ndGgpICE9IGFwaVByZWZpeCkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5JTlZBTElEX0pTT04sXG4gICAgICAgICdjYW5ub3Qgcm91dGUgYmF0Y2ggcGF0aCAnICsgcmVxdWVzdFBhdGhcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBwYXRoLnBvc2l4LmpvaW4oJy8nLCByZXF1ZXN0UGF0aC5zbGljZShhcGlQcmVmaXgubGVuZ3RoKSk7XG4gIH07XG5cbiAgaWYgKHNlcnZlclVSTCAmJiBwdWJsaWNTZXJ2ZXJVUkwgJiYgc2VydmVyVVJMLnBhdGggIT0gcHVibGljU2VydmVyVVJMLnBhdGgpIHtcbiAgICBjb25zdCBsb2NhbFBhdGggPSBzZXJ2ZXJVUkwucGF0aDtcbiAgICBjb25zdCBwdWJsaWNQYXRoID0gcHVibGljU2VydmVyVVJMLnBhdGg7XG4gICAgLy8gT3ZlcnJpZGUgdGhlIGFwaSBwcmVmaXhcbiAgICBhcGlQcmVmaXggPSBsb2NhbFBhdGg7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKHJlcXVlc3RQYXRoKSB7XG4gICAgICAvLyBCdWlsZCB0aGUgbmV3IHBhdGggYnkgcmVtb3ZpbmcgdGhlIHB1YmxpYyBwYXRoXG4gICAgICAvLyBhbmQgam9pbmluZyB3aXRoIHRoZSBsb2NhbCBwYXRoXG4gICAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5wb3NpeC5qb2luKFxuICAgICAgICAnLycsXG4gICAgICAgIGxvY2FsUGF0aCxcbiAgICAgICAgJy8nLFxuICAgICAgICByZXF1ZXN0UGF0aC5zbGljZShwdWJsaWNQYXRoLmxlbmd0aClcbiAgICAgICk7XG4gICAgICAvLyBVc2UgdGhlIG1ldGhvZCBmb3IgbG9jYWwgcm91dGluZ1xuICAgICAgcmV0dXJuIG1ha2VSb3V0YWJsZVBhdGgobmV3UGF0aCk7XG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiBtYWtlUm91dGFibGVQYXRoO1xufVxuXG4vLyBSZXR1cm5zIGEgcHJvbWlzZSBmb3IgYSB7cmVzcG9uc2V9IG9iamVjdC5cbi8vIFRPRE86IHBhc3MgYWxvbmcgYXV0aCBjb3JyZWN0bHlcbmZ1bmN0aW9uIGhhbmRsZUJhdGNoKHJvdXRlciwgcmVxKSB7XG4gIGlmICghQXJyYXkuaXNBcnJheShyZXEuYm9keS5yZXF1ZXN0cykpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5JTlZBTElEX0pTT04sXG4gICAgICAncmVxdWVzdHMgbXVzdCBiZSBhbiBhcnJheSdcbiAgICApO1xuICB9XG5cbiAgLy8gVGhlIGJhdGNoIHBhdGhzIGFyZSBhbGwgZnJvbSB0aGUgcm9vdCBvZiBvdXIgZG9tYWluLlxuICAvLyBUaGF0IG1lYW5zIHRoZXkgaW5jbHVkZSB0aGUgQVBJIHByZWZpeCwgdGhhdCB0aGUgQVBJIGlzIG1vdW50ZWRcbiAgLy8gdG8uIEhvd2V2ZXIsIG91ciBwcm9taXNlIHJvdXRlciBkb2VzIG5vdCByb3V0ZSB0aGUgYXBpIHByZWZpeC4gU29cbiAgLy8gd2UgbmVlZCB0byBmaWd1cmUgb3V0IHRoZSBBUEkgcHJlZml4LCBzbyB0aGF0IHdlIGNhbiBzdHJpcCBpdFxuICAvLyBmcm9tIGFsbCB0aGUgc3VicmVxdWVzdHMuXG4gIGlmICghcmVxLm9yaWdpbmFsVXJsLmVuZHNXaXRoKGJhdGNoUGF0aCkpIHtcbiAgICB0aHJvdyAnaW50ZXJuYWwgcm91dGluZyBwcm9ibGVtIC0gZXhwZWN0ZWQgdXJsIHRvIGVuZCB3aXRoIGJhdGNoJztcbiAgfVxuXG4gIGNvbnN0IG1ha2VSb3V0YWJsZVBhdGggPSBtYWtlQmF0Y2hSb3V0aW5nUGF0aEZ1bmN0aW9uKFxuICAgIHJlcS5vcmlnaW5hbFVybCxcbiAgICByZXEuY29uZmlnLnNlcnZlclVSTCxcbiAgICByZXEuY29uZmlnLnB1YmxpY1NlcnZlclVSTFxuICApO1xuXG4gIGNvbnN0IHByb21pc2VzID0gcmVxLmJvZHkucmVxdWVzdHMubWFwKHJlc3RSZXF1ZXN0ID0+IHtcbiAgICBjb25zdCByb3V0YWJsZVBhdGggPSBtYWtlUm91dGFibGVQYXRoKHJlc3RSZXF1ZXN0LnBhdGgpO1xuICAgIC8vIENvbnN0cnVjdCBhIHJlcXVlc3QgdGhhdCB3ZSBjYW4gc2VuZCB0byBhIGhhbmRsZXJcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgYm9keTogcmVzdFJlcXVlc3QuYm9keSxcbiAgICAgIGNvbmZpZzogcmVxLmNvbmZpZyxcbiAgICAgIGF1dGg6IHJlcS5hdXRoLFxuICAgICAgaW5mbzogcmVxLmluZm8sXG4gICAgfTtcblxuICAgIHJldHVybiByb3V0ZXJcbiAgICAgIC50cnlSb3V0ZVJlcXVlc3QocmVzdFJlcXVlc3QubWV0aG9kLCByb3V0YWJsZVBhdGgsIHJlcXVlc3QpXG4gICAgICAudGhlbihcbiAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHJlc3BvbnNlLnJlc3BvbnNlIH07XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBlcnJvci5jb2RlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9IH07XG4gICAgICAgIH1cbiAgICAgICk7XG4gIH0pO1xuXG4gIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbihyZXN1bHRzID0+IHtcbiAgICByZXR1cm4geyByZXNwb25zZTogcmVzdWx0cyB9O1xuICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIG1vdW50T250byxcbiAgbWFrZUJhdGNoUm91dGluZ1BhdGhGdW5jdGlvbixcbn07XG4iXX0=