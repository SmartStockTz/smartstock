"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _commander = require("commander");

var _path = _interopRequireDefault(require("path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-console */
let _definitions;

let _reverseDefinitions;

let _defaults;

_commander.Command.prototype.loadDefinitions = function (definitions) {
  _definitions = definitions;
  Object.keys(definitions).reduce((program, opt) => {
    if (typeof definitions[opt] == 'object') {
      const additionalOptions = definitions[opt];

      if (additionalOptions.required === true) {
        return program.option(`--${opt} <${opt}>`, additionalOptions.help, additionalOptions.action);
      } else {
        return program.option(`--${opt} [${opt}]`, additionalOptions.help, additionalOptions.action);
      }
    }

    return program.option(`--${opt} [${opt}]`);
  }, this);
  _reverseDefinitions = Object.keys(definitions).reduce((object, key) => {
    let value = definitions[key];

    if (typeof value == 'object') {
      value = value.env;
    }

    if (value) {
      object[value] = key;
    }

    return object;
  }, {});
  _defaults = Object.keys(definitions).reduce((defs, opt) => {
    if (_definitions[opt].default) {
      defs[opt] = _definitions[opt].default;
    }

    return defs;
  }, {});
  /* istanbul ignore next */

  this.on('--help', function () {
    console.log('  Configure From Environment:');
    console.log('');
    Object.keys(_reverseDefinitions).forEach(key => {
      console.log(`    $ ${key}='${_reverseDefinitions[key]}'`);
    });
    console.log('');
  });
};

function parseEnvironment(env = {}) {
  return Object.keys(_reverseDefinitions).reduce((options, key) => {
    if (env[key]) {
      const originalKey = _reverseDefinitions[key];

      let action = option => option;

      if (typeof _definitions[originalKey] === 'object') {
        action = _definitions[originalKey].action || action;
      }

      options[_reverseDefinitions[key]] = action(env[key]);
    }

    return options;
  }, {});
}

function parseConfigFile(program) {
  let options = {};

  if (program.args.length > 0) {
    let jsonPath = program.args[0];
    jsonPath = _path.default.resolve(jsonPath);

    const jsonConfig = require(jsonPath);

    if (jsonConfig.apps) {
      if (jsonConfig.apps.length > 1) {
        throw 'Multiple apps are not supported';
      }

      options = jsonConfig.apps[0];
    } else {
      options = jsonConfig;
    }

    Object.keys(options).forEach(key => {
      const value = options[key];

      if (!_definitions[key]) {
        throw `error: unknown option ${key}`;
      }

      const action = _definitions[key].action;

      if (action) {
        options[key] = action(value);
      }
    });
    console.log(`Configuration loaded from ${jsonPath}`);
  }

  return options;
}

_commander.Command.prototype.setValuesIfNeeded = function (options) {
  Object.keys(options).forEach(key => {
    if (!this.hasOwnProperty(key)) {
      this[key] = options[key];
    }
  });
};

_commander.Command.prototype._parse = _commander.Command.prototype.parse;

_commander.Command.prototype.parse = function (args, env) {
  this._parse(args); // Parse the environment first


  const envOptions = parseEnvironment(env);
  const fromFile = parseConfigFile(this); // Load the env if not passed from command line

  this.setValuesIfNeeded(envOptions); // Load from file to override

  this.setValuesIfNeeded(fromFile); // Last set the defaults

  this.setValuesIfNeeded(_defaults);
};

_commander.Command.prototype.getOptions = function () {
  return Object.keys(_definitions).reduce((options, key) => {
    if (typeof this[key] !== 'undefined') {
      options[key] = this[key];
    }

    return options;
  }, {});
};

var _default = new _commander.Command();
/* eslint-enable no-console */


exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGkvdXRpbHMvY29tbWFuZGVyLmpzIl0sIm5hbWVzIjpbIl9kZWZpbml0aW9ucyIsIl9yZXZlcnNlRGVmaW5pdGlvbnMiLCJfZGVmYXVsdHMiLCJDb21tYW5kIiwicHJvdG90eXBlIiwibG9hZERlZmluaXRpb25zIiwiZGVmaW5pdGlvbnMiLCJPYmplY3QiLCJrZXlzIiwicmVkdWNlIiwicHJvZ3JhbSIsIm9wdCIsImFkZGl0aW9uYWxPcHRpb25zIiwicmVxdWlyZWQiLCJvcHRpb24iLCJoZWxwIiwiYWN0aW9uIiwib2JqZWN0Iiwia2V5IiwidmFsdWUiLCJlbnYiLCJkZWZzIiwiZGVmYXVsdCIsIm9uIiwiY29uc29sZSIsImxvZyIsImZvckVhY2giLCJwYXJzZUVudmlyb25tZW50Iiwib3B0aW9ucyIsIm9yaWdpbmFsS2V5IiwicGFyc2VDb25maWdGaWxlIiwiYXJncyIsImxlbmd0aCIsImpzb25QYXRoIiwicGF0aCIsInJlc29sdmUiLCJqc29uQ29uZmlnIiwicmVxdWlyZSIsImFwcHMiLCJzZXRWYWx1ZXNJZk5lZWRlZCIsImhhc093blByb3BlcnR5IiwiX3BhcnNlIiwicGFyc2UiLCJlbnZPcHRpb25zIiwiZnJvbUZpbGUiLCJnZXRPcHRpb25zIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBQ0E7Ozs7QUFGQTtBQUdBLElBQUlBLFlBQUo7O0FBQ0EsSUFBSUMsbUJBQUo7O0FBQ0EsSUFBSUMsU0FBSjs7QUFFQUMsbUJBQVFDLFNBQVIsQ0FBa0JDLGVBQWxCLEdBQW9DLFVBQVNDLFdBQVQsRUFBc0I7QUFDeEROLEVBQUFBLFlBQVksR0FBR00sV0FBZjtBQUVBQyxFQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWUYsV0FBWixFQUF5QkcsTUFBekIsQ0FBZ0MsQ0FBQ0MsT0FBRCxFQUFVQyxHQUFWLEtBQWtCO0FBQ2hELFFBQUksT0FBT0wsV0FBVyxDQUFDSyxHQUFELENBQWxCLElBQTJCLFFBQS9CLEVBQXlDO0FBQ3ZDLFlB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SUFBUCxDQUFZUixZQUFaLEVBQTBCUyxNQUExQixDQUFpQyxDQUFDbUIsT0FBRCxFQUFVVixHQUFWLEtBQWtCO0FBQ3hELFFBQUksT0FBTyxLQUFLQSxHQUFMLENBQVAsS0FBcUIsV0FBekIsRUFBc0M7QUFDcENVLE1BQUFBLE9BQU8sQ0FBQ1YsR0FBRCxDQUFQLEdBQWUsS0FBS0EsR0FBTCxDQUFmO0FBQ0Q7O0FBQ0QsV0FBT1UsT0FBUDtBQUNELEdBTE0sRUFLSixFQUxJLENBQVA7QUFNRCxDQVBEOztlQVNlLElBQUl6QixrQkFBSixFO0FBQ2YiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovXG5pbXBvcnQgeyBDb21tYW5kIH0gZnJvbSAnY29tbWFuZGVyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xubGV0IF9kZWZpbml0aW9ucztcbmxldCBfcmV2ZXJzZURlZmluaXRpb25zO1xubGV0IF9kZWZhdWx0cztcblxuQ29tbWFuZC5wcm90b3R5cGUubG9hZERlZmluaXRpb25zID0gZnVuY3Rpb24oZGVmaW5pdGlvbnMpIHtcbiAgX2RlZmluaXRpb25zID0gZGVmaW5pdGlvbnM7XG5cbiAgT2JqZWN0LmtleXMoZGVmaW5pdGlvbnMpLnJlZHVjZSgocHJvZ3JhbSwgb3B0KSA9PiB7XG4gICAgaWYgKHR5cGVvZiBkZWZpbml0aW9uc1tvcHRdID09ICdvYmplY3QnKSB7XG4gICAgICBjb25zdCBhZGRpdGlvbmFsT3B0aW9ucyA9IGRlZmluaXRpb25zW29wdF07XG4gICAgICBpZiAoYWRkaXRpb25hbE9wdGlvbnMucmVxdWlyZWQgPT09IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIHByb2dyYW0ub3B0aW9uKFxuICAgICAgICAgIGAtLSR7b3B0fSA8JHtvcHR9PmAsXG4gICAgICAgICAgYWRkaXRpb25hbE9wdGlvbnMuaGVscCxcbiAgICAgICAgICBhZGRpdGlvbmFsT3B0aW9ucy5hY3Rpb25cbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBwcm9ncmFtLm9wdGlvbihcbiAgICAgICAgICBgLS0ke29wdH0gWyR7b3B0fV1gLFxuICAgICAgICAgIGFkZGl0aW9uYWxPcHRpb25zLmhlbHAsXG4gICAgICAgICAgYWRkaXRpb25hbE9wdGlvbnMuYWN0aW9uXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBwcm9ncmFtLm9wdGlvbihgLS0ke29wdH0gWyR7b3B0fV1gKTtcbiAgfSwgdGhpcyk7XG5cbiAgX3JldmVyc2VEZWZpbml0aW9ucyA9IE9iamVjdC5rZXlzKGRlZmluaXRpb25zKS5yZWR1Y2UoKG9iamVjdCwga2V5KSA9PiB7XG4gICAgbGV0IHZhbHVlID0gZGVmaW5pdGlvbnNba2V5XTtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09ICdvYmplY3QnKSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlLmVudjtcbiAgICB9XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICBvYmplY3RbdmFsdWVdID0ga2V5O1xuICAgIH1cbiAgICByZXR1cm4gb2JqZWN0O1xuICB9LCB7fSk7XG5cbiAgX2RlZmF1bHRzID0gT2JqZWN0LmtleXMoZGVmaW5pdGlvbnMpLnJlZHVjZSgoZGVmcywgb3B0KSA9PiB7XG4gICAgaWYgKF9kZWZpbml0aW9uc1tvcHRdLmRlZmF1bHQpIHtcbiAgICAgIGRlZnNbb3B0XSA9IF9kZWZpbml0aW9uc1tvcHRdLmRlZmF1bHQ7XG4gICAgfVxuICAgIHJldHVybiBkZWZzO1xuICB9LCB7fSk7XG5cbiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgdGhpcy5vbignLS1oZWxwJywgZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJyAgQ29uZmlndXJlIEZyb20gRW52aXJvbm1lbnQ6Jyk7XG4gICAgY29uc29sZS5sb2coJycpO1xuICAgIE9iamVjdC5rZXlzKF9yZXZlcnNlRGVmaW5pdGlvbnMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGAgICAgJCAke2tleX09JyR7X3JldmVyc2VEZWZpbml0aW9uc1trZXldfSdgKTtcbiAgICB9KTtcbiAgICBjb25zb2xlLmxvZygnJyk7XG4gIH0pO1xufTtcblxuZnVuY3Rpb24gcGFyc2VFbnZpcm9ubWVudChlbnYgPSB7fSkge1xuICByZXR1cm4gT2JqZWN0LmtleXMoX3JldmVyc2VEZWZpbml0aW9ucykucmVkdWNlKChvcHRpb25zLCBrZXkpID0+IHtcbiAgICBpZiAoZW52W2tleV0pIHtcbiAgICAgIGNvbnN0IG9yaWdpbmFsS2V5ID0gX3JldmVyc2VEZWZpbml0aW9uc1trZXldO1xuICAgICAgbGV0IGFjdGlvbiA9IG9wdGlvbiA9PiBvcHRpb247XG4gICAgICBpZiAodHlwZW9mIF9kZWZpbml0aW9uc1tvcmlnaW5hbEtleV0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGFjdGlvbiA9IF9kZWZpbml0aW9uc1tvcmlnaW5hbEtleV0uYWN0aW9uIHx8IGFjdGlvbjtcbiAgICAgIH1cbiAgICAgIG9wdGlvbnNbX3JldmVyc2VEZWZpbml0aW9uc1trZXldXSA9IGFjdGlvbihlbnZba2V5XSk7XG4gICAgfVxuICAgIHJldHVybiBvcHRpb25zO1xuICB9LCB7fSk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlQ29uZmlnRmlsZShwcm9ncmFtKSB7XG4gIGxldCBvcHRpb25zID0ge307XG4gIGlmIChwcm9ncmFtLmFyZ3MubGVuZ3RoID4gMCkge1xuICAgIGxldCBqc29uUGF0aCA9IHByb2dyYW0uYXJnc1swXTtcbiAgICBqc29uUGF0aCA9IHBhdGgucmVzb2x2ZShqc29uUGF0aCk7XG4gICAgY29uc3QganNvbkNvbmZpZyA9IHJlcXVpcmUoanNvblBhdGgpO1xuICAgIGlmIChqc29uQ29uZmlnLmFwcHMpIHtcbiAgICAgIGlmIChqc29uQ29uZmlnLmFwcHMubGVuZ3RoID4gMSkge1xuICAgICAgICB0aHJvdyAnTXVsdGlwbGUgYXBwcyBhcmUgbm90IHN1cHBvcnRlZCc7XG4gICAgICB9XG4gICAgICBvcHRpb25zID0ganNvbkNvbmZpZy5hcHBzWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICBvcHRpb25zID0ganNvbkNvbmZpZztcbiAgICB9XG4gICAgT2JqZWN0LmtleXMob3B0aW9ucykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBvcHRpb25zW2tleV07XG4gICAgICBpZiAoIV9kZWZpbml0aW9uc1trZXldKSB7XG4gICAgICAgIHRocm93IGBlcnJvcjogdW5rbm93biBvcHRpb24gJHtrZXl9YDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGFjdGlvbiA9IF9kZWZpbml0aW9uc1trZXldLmFjdGlvbjtcbiAgICAgIGlmIChhY3Rpb24pIHtcbiAgICAgICAgb3B0aW9uc1trZXldID0gYWN0aW9uKHZhbHVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zb2xlLmxvZyhgQ29uZmlndXJhdGlvbiBsb2FkZWQgZnJvbSAke2pzb25QYXRofWApO1xuICB9XG4gIHJldHVybiBvcHRpb25zO1xufVxuXG5Db21tYW5kLnByb3RvdHlwZS5zZXRWYWx1ZXNJZk5lZWRlZCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcbiAgT2JqZWN0LmtleXMob3B0aW9ucykuZm9yRWFjaChrZXkgPT4ge1xuICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICB0aGlzW2tleV0gPSBvcHRpb25zW2tleV07XG4gICAgfVxuICB9KTtcbn07XG5cbkNvbW1hbmQucHJvdG90eXBlLl9wYXJzZSA9IENvbW1hbmQucHJvdG90eXBlLnBhcnNlO1xuXG5Db21tYW5kLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKGFyZ3MsIGVudikge1xuICB0aGlzLl9wYXJzZShhcmdzKTtcbiAgLy8gUGFyc2UgdGhlIGVudmlyb25tZW50IGZpcnN0XG4gIGNvbnN0IGVudk9wdGlvbnMgPSBwYXJzZUVudmlyb25tZW50KGVudik7XG4gIGNvbnN0IGZyb21GaWxlID0gcGFyc2VDb25maWdGaWxlKHRoaXMpO1xuICAvLyBMb2FkIHRoZSBlbnYgaWYgbm90IHBhc3NlZCBmcm9tIGNvbW1hbmQgbGluZVxuICB0aGlzLnNldFZhbHVlc0lmTmVlZGVkKGVudk9wdGlvbnMpO1xuICAvLyBMb2FkIGZyb20gZmlsZSB0byBvdmVycmlkZVxuICB0aGlzLnNldFZhbHVlc0lmTmVlZGVkKGZyb21GaWxlKTtcbiAgLy8gTGFzdCBzZXQgdGhlIGRlZmF1bHRzXG4gIHRoaXMuc2V0VmFsdWVzSWZOZWVkZWQoX2RlZmF1bHRzKTtcbn07XG5cbkNvbW1hbmQucHJvdG90eXBlLmdldE9wdGlvbnMgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKF9kZWZpbml0aW9ucykucmVkdWNlKChvcHRpb25zLCBrZXkpID0+IHtcbiAgICBpZiAodHlwZW9mIHRoaXNba2V5XSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIG9wdGlvbnNba2V5XSA9IHRoaXNba2V5XTtcbiAgICB9XG4gICAgcmV0dXJuIG9wdGlvbnM7XG4gIH0sIHt9KTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBDb21tYW5kKCk7XG4vKiBlc2xpbnQtZW5hYmxlIG5vLWNvbnNvbGUgKi9cbiJdfQ==