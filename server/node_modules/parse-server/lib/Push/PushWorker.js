"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PushWorker = void 0;

var _deepcopy = _interopRequireDefault(require("deepcopy"));

var _AdaptableController = _interopRequireDefault(require("../Controllers/AdaptableController"));

var _Auth = require("../Auth");

var _Config = _interopRequireDefault(require("../Config"));

var _PushAdapter = require("../Adapters/Push/PushAdapter");

var _rest = _interopRequireDefault(require("../rest"));

var _StatusHandler = require("../StatusHandler");

var utils = _interopRequireWildcard(require("./utils"));

var _ParseMessageQueue = require("../ParseMessageQueue");

var _PushQueue = require("./PushQueue");

var _logger = _interopRequireDefault(require("../logger"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// -disable-next
function groupByBadge(installations) {
  return installations.reduce((map, installation) => {
    const badge = installation.badge + '';
    map[badge] = map[badge] || [];
    map[badge].push(installation);
    return map;
  }, {});
}

class PushWorker {
  constructor(pushAdapter, subscriberConfig = {}) {
    _AdaptableController.default.validateAdapter(pushAdapter, this, _PushAdapter.PushAdapter);

    this.adapter = pushAdapter;
    this.channel = subscriberConfig.channel || _PushQueue.PushQueue.defaultPushChannel();
    this.subscriber = _ParseMessageQueue.ParseMessageQueue.createSubscriber(subscriberConfig);

    if (this.subscriber) {
      const subscriber = this.subscriber;
      subscriber.subscribe(this.channel);
      subscriber.on('message', (channel, messageStr) => {
        const workItem = JSON.parse(messageStr);
        this.run(workItem);
      });
    }
  }

  run({
    body,
    query,
    pushStatus,
    applicationId,
    UTCOffset
  }) {
    const config = _Config.default.get(applicationId);

    const auth = (0, _Auth.master)(config);
    const where = utils.applyDeviceTokenExists(query.where);
    delete query.where;
    pushStatus = (0, _StatusHandler.pushStatusHandler)(config, pushStatus.objectId);
    return _rest.default.find(config, auth, '_Installation', where, query).then(({
      results
    }) => {
      if (results.length == 0) {
        return;
      }

      return this.sendToAdapter(body, results, pushStatus, config, UTCOffset);
    });
  }

  sendToAdapter(body, installations, pushStatus, config, UTCOffset) {
    // Check if we have locales in the push body
    const locales = utils.getLocalesFromPush(body);

    if (locales.length > 0) {
      // Get all tranformed bodies for each locale
      const bodiesPerLocales = utils.bodiesPerLocales(body, locales); // Group installations on the specified locales (en, fr, default etc...)

      const grouppedInstallations = utils.groupByLocaleIdentifier(installations, locales);
      const promises = Object.keys(grouppedInstallations).map(locale => {
        const installations = grouppedInstallations[locale];
        const body = bodiesPerLocales[locale];
        return this.sendToAdapter(body, installations, pushStatus, config, UTCOffset);
      });
      return Promise.all(promises);
    }

    if (!utils.isPushIncrementing(body)) {
      _logger.default.verbose(`Sending push to ${installations.length}`);

      return this.adapter.send(body, installations, pushStatus.objectId).then(results => {
        return pushStatus.trackSent(results, UTCOffset).then(() => results);
      });
    } // Collect the badges to reduce the # of calls


    const badgeInstallationsMap = groupByBadge(installations); // Map the on the badges count and return the send result

    const promises = Object.keys(badgeInstallationsMap).map(badge => {
      const payload = (0, _deepcopy.default)(body);
      payload.data.badge = parseInt(badge);
      const installations = badgeInstallationsMap[badge];
      return this.sendToAdapter(payload, installations, pushStatus, config, UTCOffset);
    });
    return Promise.all(promises);
  }

}

exports.PushWorker = PushWorker;
var _default = PushWorker;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QdXNoL1B1c2hXb3JrZXIuanMiXSwibmFtZXMiOlsiZ3JvdXBCeUJhZGdlIiwiaW5zdGFsbGF0aW9ucyIsInJlZHVjZSIsIm1hcCIsImluc3RhbGxhdGlvbiIsImJhZGdlIiwicHVzaCIsIlB1c2hXb3JrZXIiLCJjb25zdHJ1Y3RvciIsInB1c2hBZGFwdGVyIiwic3Vic2NyaWJlckNvbmZpZyIsIkFkYXB0YWJsZUNvbnRyb2xsZXIiLCJ2YWxpZGF0ZUFkYXB0ZXIiLCJQdXNoQWRhcHRlciIsImFkYXB0ZXIiLCJjaGFubmVsIiwiUHVzaFF1ZXVlIiwiZGVmYXVsdFB1c2hDaGFubmVsIiwic3Vic2NyaWJlciIsIlBhcnNlTWVzc2FnZVF1ZXVlIiwiY3JlYXRlU3Vic2NyaWJlciIsInN1YnNjcmliZSIsIm9uIiwibWVzc2FnZVN0ciIsIndvcmtJdGVtIiwiSlNPTiIsInBhcnNlIiwicnVuIiwiYm9keSIsInF1ZXJ5IiwicHVzaFN0YXR1cyIsImFwcGxpY2F0aW9uSWQiLCJVVENPZmZzZXQiLCJjb25maWciLCJDb25maWciLCJnZXQiLCJhdXRoIiwid2hlcmUiLCJ1dGlscyIsImFwcGx5RGV2aWNlVG9rZW5FeGlzdHMiLCJvYmplY3RJZCIsInJlc3QiLCJmaW5kIiwidGhlbiIsInJlc3VsdHMiLCJsZW5ndGgiLCJzZW5kVG9BZGFwdGVyIiwibG9jYWxlcyIsImdldExvY2FsZXNGcm9tUHVzaCIsImJvZGllc1BlckxvY2FsZXMiLCJncm91cHBlZEluc3RhbGxhdGlvbnMiLCJncm91cEJ5TG9jYWxlSWRlbnRpZmllciIsInByb21pc2VzIiwiT2JqZWN0Iiwia2V5cyIsImxvY2FsZSIsIlByb21pc2UiLCJhbGwiLCJpc1B1c2hJbmNyZW1lbnRpbmciLCJsb2dnZXIiLCJ2ZXJib3NlIiwic2VuZCIsInRyYWNrU2VudCIsImJhZGdlSW5zdGFsbGF0aW9uc01hcCIsInBheWxvYWQiLCJkYXRhIiwicGFyc2VJbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7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QU1tQixxQkFBcUIsR0FBRy9ELFlBQVksQ0FBQ0MsYUFBRCxDQUExQyxDQXBDWSxDQXNDWjs7QUFDQSxVQUFNbUQsUUFBUSxHQUFHQyxNQUFNLENBQUNDLElBQVAsQ0FBWVMscUJBQVosRUFBbUM1RCxHQUFuQyxDQUF1Q0UsS0FBSyxJQUFJO0FBQy9ELFlBQU0yRCxPQUFPLEdBQUcsdUJBQVNwQyxJQUFULENBQWhCO0FBQ0FvQyxNQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FBYTVELEtBQWIsR0FBcUI2RCxRQUFRLENBQUM3RCxLQUFELENBQTdCO0FBQ0EsWUFBTUosYUFBYSxHQUFHOEQscUJBQXFCLENBQUMxRCxLQUFELENBQTNDO0FBQ0EsYUFBTyxLQUFLeUMsYUFBTCxDQUNMa0IsT0FESyxFQUVML0QsYUFGSyxFQUdMNkIsVUFISyxFQUlMRyxNQUpLLEVBS0xELFNBTEssQ0FBUDtBQU9ELEtBWGdCLENBQWpCO0FBWUEsV0FBT3dCLE9BQU8sQ0FBQ0MsR0FBUixDQUFZTCxRQUFaLENBQVA7QUFDRDs7QUEvRnFCOzs7ZUFrR1Q3QyxVIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbi8vIEBmbG93LWRpc2FibGUtbmV4dFxuaW1wb3J0IGRlZXBjb3B5IGZyb20gJ2RlZXBjb3B5JztcbmltcG9ydCBBZGFwdGFibGVDb250cm9sbGVyIGZyb20gJy4uL0NvbnRyb2xsZXJzL0FkYXB0YWJsZUNvbnRyb2xsZXInO1xuaW1wb3J0IHsgbWFzdGVyIH0gZnJvbSAnLi4vQXV0aCc7XG5pbXBvcnQgQ29uZmlnIGZyb20gJy4uL0NvbmZpZyc7XG5pbXBvcnQgeyBQdXNoQWRhcHRlciB9IGZyb20gJy4uL0FkYXB0ZXJzL1B1c2gvUHVzaEFkYXB0ZXInO1xuaW1wb3J0IHJlc3QgZnJvbSAnLi4vcmVzdCc7XG5pbXBvcnQgeyBwdXNoU3RhdHVzSGFuZGxlciB9IGZyb20gJy4uL1N0YXR1c0hhbmRsZXInO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBQYXJzZU1lc3NhZ2VRdWV1ZSB9IGZyb20gJy4uL1BhcnNlTWVzc2FnZVF1ZXVlJztcbmltcG9ydCB7IFB1c2hRdWV1ZSB9IGZyb20gJy4vUHVzaFF1ZXVlJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcblxuZnVuY3Rpb24gZ3JvdXBCeUJhZGdlKGluc3RhbGxhdGlvbnMpIHtcbiAgcmV0dXJuIGluc3RhbGxhdGlvbnMucmVkdWNlKChtYXAsIGluc3RhbGxhdGlvbikgPT4ge1xuICAgIGNvbnN0IGJhZGdlID0gaW5zdGFsbGF0aW9uLmJhZGdlICsgJyc7XG4gICAgbWFwW2JhZGdlXSA9IG1hcFtiYWRnZV0gfHwgW107XG4gICAgbWFwW2JhZGdlXS5wdXNoKGluc3RhbGxhdGlvbik7XG4gICAgcmV0dXJuIG1hcDtcbiAgfSwge30pO1xufVxuXG5leHBvcnQgY2xhc3MgUHVzaFdvcmtlciB7XG4gIHN1YnNjcmliZXI6ID9hbnk7XG4gIGFkYXB0ZXI6IGFueTtcbiAgY2hhbm5lbDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHB1c2hBZGFwdGVyOiBQdXNoQWRhcHRlciwgc3Vic2NyaWJlckNvbmZpZzogYW55ID0ge30pIHtcbiAgICBBZGFwdGFibGVDb250cm9sbGVyLnZhbGlkYXRlQWRhcHRlcihwdXNoQWRhcHRlciwgdGhpcywgUHVzaEFkYXB0ZXIpO1xuICAgIHRoaXMuYWRhcHRlciA9IHB1c2hBZGFwdGVyO1xuXG4gICAgdGhpcy5jaGFubmVsID0gc3Vic2NyaWJlckNvbmZpZy5jaGFubmVsIHx8IFB1c2hRdWV1ZS5kZWZhdWx0UHVzaENoYW5uZWwoKTtcbiAgICB0aGlzLnN1YnNjcmliZXIgPSBQYXJzZU1lc3NhZ2VRdWV1ZS5jcmVhdGVTdWJzY3JpYmVyKHN1YnNjcmliZXJDb25maWcpO1xuICAgIGlmICh0aGlzLnN1YnNjcmliZXIpIHtcbiAgICAgIGNvbnN0IHN1YnNjcmliZXIgPSB0aGlzLnN1YnNjcmliZXI7XG4gICAgICBzdWJzY3JpYmVyLnN1YnNjcmliZSh0aGlzLmNoYW5uZWwpO1xuICAgICAgc3Vic2NyaWJlci5vbignbWVzc2FnZScsIChjaGFubmVsLCBtZXNzYWdlU3RyKSA9PiB7XG4gICAgICAgIGNvbnN0IHdvcmtJdGVtID0gSlNPTi5wYXJzZShtZXNzYWdlU3RyKTtcbiAgICAgICAgdGhpcy5ydW4od29ya0l0ZW0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcnVuKHsgYm9keSwgcXVlcnksIHB1c2hTdGF0dXMsIGFwcGxpY2F0aW9uSWQsIFVUQ09mZnNldCB9OiBhbnkpOiBQcm9taXNlPCo+IHtcbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KGFwcGxpY2F0aW9uSWQpO1xuICAgIGNvbnN0IGF1dGggPSBtYXN0ZXIoY29uZmlnKTtcbiAgICBjb25zdCB3aGVyZSA9IHV0aWxzLmFwcGx5RGV2aWNlVG9rZW5FeGlzdHMocXVlcnkud2hlcmUpO1xuICAgIGRlbGV0ZSBxdWVyeS53aGVyZTtcbiAgICBwdXNoU3RhdHVzID0gcHVzaFN0YXR1c0hhbmRsZXIoY29uZmlnLCBwdXNoU3RhdHVzLm9iamVjdElkKTtcbiAgICByZXR1cm4gcmVzdFxuICAgICAgLmZpbmQoY29uZmlnLCBhdXRoLCAnX0luc3RhbGxhdGlvbicsIHdoZXJlLCBxdWVyeSlcbiAgICAgIC50aGVuKCh7IHJlc3VsdHMgfSkgPT4ge1xuICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPT0gMCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kVG9BZGFwdGVyKGJvZHksIHJlc3VsdHMsIHB1c2hTdGF0dXMsIGNvbmZpZywgVVRDT2Zmc2V0KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgc2VuZFRvQWRhcHRlcihcbiAgICBib2R5OiBhbnksXG4gICAgaW5zdGFsbGF0aW9uczogYW55W10sXG4gICAgcHVzaFN0YXR1czogYW55LFxuICAgIGNvbmZpZzogQ29uZmlnLFxuICAgIFVUQ09mZnNldDogP2FueVxuICApOiBQcm9taXNlPCo+IHtcbiAgICAvLyBDaGVjayBpZiB3ZSBoYXZlIGxvY2FsZXMgaW4gdGhlIHB1c2ggYm9keVxuICAgIGNvbnN0IGxvY2FsZXMgPSB1dGlscy5nZXRMb2NhbGVzRnJvbVB1c2goYm9keSk7XG4gICAgaWYgKGxvY2FsZXMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gR2V0IGFsbCB0cmFuZm9ybWVkIGJvZGllcyBmb3IgZWFjaCBsb2NhbGVcbiAgICAgIGNvbnN0IGJvZGllc1BlckxvY2FsZXMgPSB1dGlscy5ib2RpZXNQZXJMb2NhbGVzKGJvZHksIGxvY2FsZXMpO1xuXG4gICAgICAvLyBHcm91cCBpbnN0YWxsYXRpb25zIG9uIHRoZSBzcGVjaWZpZWQgbG9jYWxlcyAoZW4sIGZyLCBkZWZhdWx0IGV0Yy4uLilcbiAgICAgIGNvbnN0IGdyb3VwcGVkSW5zdGFsbGF0aW9ucyA9IHV0aWxzLmdyb3VwQnlMb2NhbGVJZGVudGlmaWVyKFxuICAgICAgICBpbnN0YWxsYXRpb25zLFxuICAgICAgICBsb2NhbGVzXG4gICAgICApO1xuICAgICAgY29uc3QgcHJvbWlzZXMgPSBPYmplY3Qua2V5cyhncm91cHBlZEluc3RhbGxhdGlvbnMpLm1hcChsb2NhbGUgPT4ge1xuICAgICAgICBjb25zdCBpbnN0YWxsYXRpb25zID0gZ3JvdXBwZWRJbnN0YWxsYXRpb25zW2xvY2FsZV07XG4gICAgICAgIGNvbnN0IGJvZHkgPSBib2RpZXNQZXJMb2NhbGVzW2xvY2FsZV07XG4gICAgICAgIHJldHVybiB0aGlzLnNlbmRUb0FkYXB0ZXIoXG4gICAgICAgICAgYm9keSxcbiAgICAgICAgICBpbnN0YWxsYXRpb25zLFxuICAgICAgICAgIHB1c2hTdGF0dXMsXG4gICAgICAgICAgY29uZmlnLFxuICAgICAgICAgIFVUQ09mZnNldFxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIH1cblxuICAgIGlmICghdXRpbHMuaXNQdXNoSW5jcmVtZW50aW5nKGJvZHkpKSB7XG4gICAgICBsb2dnZXIudmVyYm9zZShgU2VuZGluZyBwdXNoIHRvICR7aW5zdGFsbGF0aW9ucy5sZW5ndGh9YCk7XG4gICAgICByZXR1cm4gdGhpcy5hZGFwdGVyXG4gICAgICAgIC5zZW5kKGJvZHksIGluc3RhbGxhdGlvbnMsIHB1c2hTdGF0dXMub2JqZWN0SWQpXG4gICAgICAgIC50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgICAgIHJldHVybiBwdXNoU3RhdHVzLnRyYWNrU2VudChyZXN1bHRzLCBVVENPZmZzZXQpLnRoZW4oKCkgPT4gcmVzdWx0cyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENvbGxlY3QgdGhlIGJhZGdlcyB0byByZWR1Y2UgdGhlICMgb2YgY2FsbHNcbiAgICBjb25zdCBiYWRnZUluc3RhbGxhdGlvbnNNYXAgPSBncm91cEJ5QmFkZ2UoaW5zdGFsbGF0aW9ucyk7XG5cbiAgICAvLyBNYXAgdGhlIG9uIHRoZSBiYWRnZXMgY291bnQgYW5kIHJldHVybiB0aGUgc2VuZCByZXN1bHRcbiAgICBjb25zdCBwcm9taXNlcyA9IE9iamVjdC5rZXlzKGJhZGdlSW5zdGFsbGF0aW9uc01hcCkubWFwKGJhZGdlID0+IHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBkZWVwY29weShib2R5KTtcbiAgICAgIHBheWxvYWQuZGF0YS5iYWRnZSA9IHBhcnNlSW50KGJhZGdlKTtcbiAgICAgIGNvbnN0IGluc3RhbGxhdGlvbnMgPSBiYWRnZUluc3RhbGxhdGlvbnNNYXBbYmFkZ2VdO1xuICAgICAgcmV0dXJuIHRoaXMuc2VuZFRvQWRhcHRlcihcbiAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgaW5zdGFsbGF0aW9ucyxcbiAgICAgICAgcHVzaFN0YXR1cyxcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBVVENPZmZzZXRcbiAgICAgICk7XG4gICAgfSk7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQdXNoV29ya2VyO1xuIl19